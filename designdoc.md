# ML System Design Doc

### 1. Цели и предпосылки

### 1.1. Зачем идем в разработку продукта?

- Бизнес-цель - создание системы автоматической детекции и распознавания автомобилей и автомобильных номеров.
- Система автоматической детекции и распознавания автомобилей позволит ускорить и автоматизировать проверку автомобилей на КПП/ на стойках въезда и выезда на платных участках дороги и др.

**Автоматизация проверки автомобилей на въезде и выезде позволит:**
- Исключить человеческий фактор и злоупотребления со стороны посетителей или персонала, повысить выручку;
- Сделать все процессы прозрачными, получить статистику для принятия взвешенных управленческих решений;
- Сократить эксплуатационные затраты;
- Сделать парковку удобной, безопасной, современной.
- Что будем считать успехом итерации с точки зрения бизнеса `Product Owner`

### 1.2. Бизнес-требования и ограничения

- Система автоматической детекции и распознавания автомобилей и автомобильных номеров будет использоваться для учета проезжающих автомобилей на автодорогах и улучшения процессов парковки. Детальные документы с бизнес-требованиями содержат информацию о требуемой точности распознавания номеров, скорости обработки данных, совместимости с другими системами и интеграции с существующими базами данных.
- Бизнес-ограничения включают в себя ограничения в обработке видеоданных с высокой скоростью, необходимость защиты персональных данных в соответствии с законодательством о конфиденциальности, а также требования к достаточной освещенности на КПП для корректной работы системы.
- От конкретной итерации ожидается разработка и оптимизация алгоритмов детекции и распознавания автомобилей и номеров на видеопотоке. Также требуется создание системы хранения и обработки полученных данных, а также разработка пользовательского интерфейса для удобного взаимодействия с системой.
- В рамках пилотного проекта система будет установлена на парковке, где будет производиться автоматическая детекция и распознавание автомобильных номеров. Результаты распознавания будут передаваться в базу данных для дальнейшего анализа и использования в существующих бизнес-процессах. Например, эти данные могут быть использованы для учета заезжающих/выезжающих автомобилей на парковке.
- Успешным пилотом будет считаться достижение высокой точности распознавания номеров, высокая скорость обработки данных и корректная интеграция с существующими системами. Критерии успеха также включают соблюдение законодательных требований по защите персональных данных и соблюдение стандартов безопасности. В случае успеха пилотного проекта, возможным путем развития проекта станет масштабирование системы на более крупные территории или внедрение дополнительных функций, например, автоматического распознавания цвета автомобиля.

### 1.3. Что входит в скоуп проекта/итерации, что не входит

- На закрытие каких БТ подписываемся в данной итерации `Data Scientist`
- Что не будет закрыто `Data Scientist`
- Описание результата с точки зрения качества кода и воспроизводимости решения `Data Scientist`
- Описание планируемого технического долга (что оставляем для дальнейшей продуктивизации) `Data Scientist`

### 1.4. Предпосылки решения

- Запрос бизнеса: Создание эффективной системы для автоматического распознавания автомобилей и их номеров на основе компьютерного зрения и методов машинного обучения поможет оптимизировать ряд процессов, таких как контроль трафика, страхование, ИТ-инфраструктура для автострад, управление муниципальными службами (например, эвакуация) и операций с представителями государственных органов. Также использование данной системы может снижать стоимость обслуживания при помощи сокращения затрат на человеческий труд для распознавания автомобилей и их номеров.
- Горизонт прогноза: В контексте данного проекта горизонт прогноза не является основополагающим моментом, так как задача состоит в распознавании автомобилей и их номеров в фиксированный момент времени, а не в предсказании будущей информации. Однако система может быть использована для анализа прошедших событий или в режиме реального времени.
- Гранулярность модели: Модель должна иметь достаточное хорошее качество, чтобы обрабатывать изображения с различными уровнями детализации, как, например, хорошо видимые автомобили и их номера на переднем плане или частично запредельные объекты на заднем плане. Главное требование - возможность корректно определить автомобиль и его номер независимо от вариаций освещения, расстояния, ракурса и качества исходного изображения или видео.
- При разработке системы детекции автомобилей и их номеров важно обеспечить ее адаптивность к изменениям внешних условий, точность распознавания и эффективность работы на реальных данных. Это позволит успешно внедрить сформированное решение в рабочие процессы и удовлетворить потребности бизнеса.

### 2. Методология `Data Scientist`

### 2.1. Постановка задачи

- Что делаем с технической точки зрения: система верификации автомобиля (computer vision)

### 2.2. Блок-схема решения

- Блок-схема для бейзлайна и основного MVP с ключевыми этапами решения задачи: подготовка данных, построение прогнозных моделей, оптимизация, тестирование, закрытие технического долга, подготовка пилота, другое. `Data Scientist`
- [Пример возможной блок схемы](https://github.com/IrinaGoloshchapova/ml_system_design_doc_ru/blob/main/product_schema.png?raw=true)

> Схема обязательно включает в себя архитектуру бейзлайна. Если бейзлайн и основной MVP отличаются несущественно, то это может быть одна блок-схема. Если значительно, то рисуем две: отдельно для бейзлайна, отдельно для основного MVP.
> 
> 
> Если блок-схема **шаблонна** - т.е. её можно скопировать и применить к разным продуктам, то она **некорректна**. Блок-схема должна показывать схему решения для конкретной задачи, поставленной в части 1.
> 

### 2.3. Этапы решения задачи `Data Scientist`

- Для каждого этапа **по результатам EDA** описываем - **отдельно для бейзлайна** и **отдельно для основного MVP** - все про данные и технику решения максимально конкретно. Обозначаем необходимые вводные, технику предполагаемого решения и что ожидаем получить на выходе, чтобы перейти к следующему этапу.
- Как правило, детальное и структурированное заполнение раздела `2.3` возможно только **по результатам EDA**.
- Если описание в дизайн доке **шаблонно** - т.е. его можно скопировать и применить к разным продуктам, то оно **некорректно**. Дизайн док должен показывать схему решения для конкретной задачи, поставленной в части 1.

> Примеры этапов:
> 
> - Этап 2 - Подготовка прогнозных моделей
> - Этап 3 - Интерпретация моделей (согл. с заказчиком)
> - Этап 4 - Интеграция бизнес правил для расчета бизнес-метрик качества мрдели
> - Этап 5 - Подготовка инференса модели по итерациям
> - Этап 6 - Интеграция бизнес правил
> - Этап 7 - Разработка оптимизатора (выбор оптимальной итерации)
> - Этап 8 - Подготовка финального отчета для бизнеса

*Этап 1 - это обычно, подготовка данных.*

В этом этапе должно быть следующее:

- Данные и сущности, на которых будет обучаться ваша модель машинного обучения. Отдельная таблица для целевой переменной (либо целевых переменных разных этапов), отдельная таблица – для признаков.

| Название данных | Есть ли данные в компании (если да, название источника/витрин) | Требуемый ресурс для получения данных (какие роли нужны) | Проверено ли качество данных (да, нет) |
| --- | --- | --- | --- |
| Продажи | DATAMARTS_SALES_PER_DAY | DE/DS | + |
| ... | ... | ... | ... |
- Краткое описание результата этапа - что должно быть на выходе: витрины данных, потоки данных, др.

> Чаще всего заполнение раздела невозможно без EDA.
> 

*Этапы 2 и далее, помимо подготовки данных.*

Описание техники **для каждого этапа** должно включать описание **отдельно для MVP** и **отдельно для бейзлайна**:

- Описание формирования выборки для обучения, тестирования и валидации. Выбор репрезентативных данных для экспериментов, обучения и подготовки пилота (от бизнес-цели и репрезентативности данных с технической точки зрения) `Data Scientist`
- Горизонт, гранулярность, частоту необходимого пересчета прогнозных моделей `Data Scientist`
- Определение целевой переменной, согласованное с бизнесом `Data Scientist`
- Какие метрики качества используем и почему они связаны с бизнес-результатом, обозначенным `Product Owner` в разделах `1` и `3`. Пример - WAPE <= 50% для > 80% категорий, bias ~ 0. Возможна формулировка в терминах относительно бейзлайна, количественно. Для бейзлайна могут быть свои целевые метрики, а может их вообще не быть (если это обосновано) `Data Scientist`
- Необходимый результат этапа. Например, необходимым результатом может быть не просто достижение каких-либо метрик качества, а включение в модели определенных факторов (флаг промо для прогноза выручки, др.) `Data Scientist`
- Какие могут быть риски и что планируем с этим делать. Например, необходимый для модели фактор (флаг промо) окажется незначимым для большинства моделей. Или для 50% моделей будет недостаточно данных для оценки `Data Scientist`
- Верхнеуровневые принципы и обоснования для: feature engineering, подбора алгоритма решения, техники кросс-валидации, интерпретации результата (если применимо).
- Предусмотрена ли бизнес-проверка результата этапа и как будет проводиться `Data Scientist` & `Product Owner`

### 3. Подготовка пилота

### 3.1. Способ оценки пилота

- Краткое описание предполагаемого дизайна и способа оценки пилота `Product Owner`, `Data Scientist` with `AB Group`

### 3.2. Что считаем успешным пилотом

Формализованные в пилоте метрики оценки успешности `Product Owner`

### 3.3. Подготовка пилота

- Что можем позволить себе, исходя из ожидаемых затрат на вычисления. Если исходно просчитать сложно, то описываем этап расчетов ожидаемой вычислительной сложности на эксперименте с бейзлайном. И предусматриваем уточнение параметров пилота и установку ограничений по вычислительной сложности моделей. `Data Scientist`

### 4. Внедрение 

### 4.1. Архитектура решения

<img src="assets/Car-Checkpoint-AI Architecture v0.1.0.png" alt="Архитектура системы">

**Сервисы (инструменты):**

- PostgreSQL (хранение метаданных)
- AWS S3 (хранение фото-видеофиксации)
- NVIDIA Triton (serving моделей в TensorRT)

**Микросервисы:**

- DB Repository - микросервис-репозиторий для обращения к БД
- Frames Cutter + Selector - микросервисы для нарезки видео на кадры и выбор “лучших для анализа” кадров
- Models Adapter - адаптер модели в Тритоне, реализует всю логику пайплайна обработки
- Frames Getter - микросервис получения видео от конечных устройств по RSTP протоколу
- Web-Back & WEB Statik Real-Time - общий интерфейс для взаимодействия с системой и просмотра проанализированных кадров

**Модели:**

- YOLO - определение есть ли машина на кадре и детекция автомобильных номеров
- EasyOCR - распознавание знаков на автомобильных номерах
- EfficientNet - определение марки, модели и поколения автомобиля

### 4.2. Описание инфраструктуры и масштабируемости

- Какая инфраструктура выбрана и почему `Data Scientist`
- Плюсы и минусы выбора `Data Scientist`
- Почему финальный выбор лучше других альтернатив `Data Scientist`

### 4.3. Требования к работе системы

Проект по детекции автомобилей и автомобильных номеров предполагает разработку и внедрение системы, способной автоматически идентифицировать автомобили и распознавать их номерные знаки. Система должна иметь следующие характеристики и соответствовать следующим требованиям:
- Точность распознавания автомобильных номеров: система должна обеспечивать высокую точность распознавания автомобильных номеров, чтобы минимизировать количество ложных срабатываний и не пропустить мимо целевые транспортные средства. Точность должна составлять не менее _%. 
- Скорость обработки изображений: система должна обрабатывать изображения с автомобилями и номерными знаками быстро, чтобы оперативно реагировать на различные ситуации. Время обработки одного снимка не должно превышать 2-3 секунд. 
- Работа в различных условиях освещения и погоды: система должна быть адаптирована для корректной работы в условиях плохой видимости, непогоды, ночного времени суток, различных типах освещения (естественное/искусственное). 
- Масштабируемость: возможность интеграции системы с другими проектами и устройствами, благодаря которому систему можно будет развернуть на большом количестве камер и расширять ее функциональность. 
- Безопасность и конфиденциальность: система должна обеспечивать безопасность хранения и передачи данных, особенно в случаях связи с системами автопарков, служб автоматического учета протоколов и т.п. К системе должны иметь доступ только авторизованные пользователи, и доступ к данным должен осуществляться только по необходимости. 
- Гибкость алгоритмов: возможность обучения и доработки алгоритмов детекции автомобилей и распознавания номеров, чтобы система была способна адаптироваться к меняющимся условиям и обеспечивать актуальность результатов.

### 4.4. Безопасность системы

- возможные DDOS атаки или другие проявления хакерски
- уязвимость хранение данных (требуется настройки бекапирования данных)
- возможны проблемы с доступом к камерам

### 4.5. Безопасность данных

- Данные, используемые для автоматического распознавания автомобильных номеров и автомобилей не являются персональными данными и не попадают под действие Федерального закона от 27.07.2006 N 152-ФЗ “О персональных данных” и GDPR (General Data Protection Regulation), ввиду чего не требуют специальных условий хранения данных.

### 4.6. Издержки

- Расчетные издержки на работу системы в месяц `Data Scientist`

### 4.5. Integration points

- Описание взаимодействия между сервисами (методы API и др.) `Data Scientist`

### 4.6. Риски
- Недостаточная качество данных: Поврежденные, неполные или неточные данные могут снизить эффективность детектирования и распознавания автомобилей и номеров. Особенно это важно при обучении моделей детекции автомобильных номеров и распознавнию знаков.
- Недопредставленность классов: Если обучающий набор данных не предоставляет адекватное разнообразие автомобильных номеров или нетипичных видов автомобилей, модель может отработать плохо на реальных данных за пределами обучающей выборки.
- Неустойчивость модели к изменениям условий: В реальных условиях модель должна справляться с различными видами освещения, погодными условиями, разными ракурсами и качеством изображений. Недостаточное обучение модели на этих вариациях может привести к снижению её эффективности.
- Высокие требования к аппаратным ресурсам: Модели могут потребовать значительных аппаратных ресурсов, что может затруднить развёртывание системы на месте использования.
- Проблемы деления данных на обучающую, валидационную и контрольную выборки: Неправильное разделение данных может привести к переобучению моделей и плохим результатам на реальных данных. Важно—добиться адекватной генерализации для успешного использования модели.
- Ошибки распознавания номеров: Неправильное определение символов номерного знака может привести к ложным срабатываниям или пропуску действительных номеров, что может негативно повлиять на качество системы.
- Выбор подходящих алгоритмов и моделей: Большое количество доступных алгоритмов и моделей машинного обучения может усложнить процесс выбора оптимального решения. Подбор подходящих методов является ключевым фактором успеха проекта.
- Неправильная оценка эффективности: Если используемые метрики оценки эффективности не адекватно отражают реальную работу системы, это может привести к любительским результатам и недооценке возможных проблем с моделью.
